<!-- ضع هذا في نفس مكان الكود السابق ضمن <body> -->
<audio id="scan-sound" loop>
  <source src="https://www.soundjay.com/misc/sounds/beep-07.mp3" type="audio/mpeg">
</audio>

<script>
document.getElementById("startBtn").addEventListener("click", async ()=>{
  const scanSound = document.getElementById("scan-sound");
  scanSound.play(); // يبدأ الصوت عند فتح البوب أب

  const popup = document.createElement("div");
  popup.id="popup";
  popup.innerHTML=`<div class="popup-content">
    <h2 id="loading-title" class="shimmer">Detecting your age...</h2>
    <div class="progress-bar"><div class="progress-fill"></div></div>
    <div class="dots"><span></span><span></span><span></span></div>
    <p id="loading-text">Analyzing face</p>
  </div>`;
  document.body.appendChild(popup);

  const modelURL=URL+"model.json";
  const metadataURL=URL+"metadata.json";
  model=await tmImage.load(modelURL,metadataURL);
  maxPredictions=model.getTotalClasses();
  webcam=new tmImage.Webcam(400,300,true);
  await webcam.setup();
  await webcam.play();
  document.getElementById("webcam-container").appendChild(webcam.canvas);

  const startTime=Date.now();
  let detectedGroup=null;
  const messages=["Detecting age...","Analyzing face...","Almost done..."];
  const loadingText=document.getElementById("loading-text");
  let msgIndex=0;
  const msgInterval = setInterval(()=>{loadingText.innerText=messages[msgIndex % messages.length];msgIndex++;},15000);

  async function loop(){
    webcam.update();
    const prediction=await model.predict(webcam.canvas);
    const best=prediction.reduce((a,b)=> a.probability>b.probability?a:b);
    if(best.probability>0.85 || (Date.now()-startTime)>=45000){
      detectedGroup=best.className;
      popup.remove();
      clearInterval(msgInterval);
      scanSound.pause(); // يوقف الصوت عند ظهور النتيجة
      showResultPopup(detectedGroup);
    } else requestAnimationFrame(loop);
  }
  loop();
});
</script>
